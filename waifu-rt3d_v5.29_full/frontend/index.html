<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>waifu-rt3d v5.29</title>
<link rel="stylesheet" href="/assets/css/theme.css"/></head>
<body>
<header class="topbar"><h1>waifu‑rt3d <span class="ver">v5.29</span></h1>
<nav><button class="tabbtn" data-tab="setup">Setup</button><button class="tabbtn" data-tab="viewer">Viewer</button><button class="tabbtn" data-tab="chat">Chat</button><button class="tabbtn" data-tab="system">System</button></nav></header>
<main>
<section id="setup" class="tab active"><h2>Setup</h2>
<div class="card grid">
<h3 style="grid-column:1/-1;margin:0;">LLM</h3>
<label>Provider<select id="provider"><option value="lmstudio">lmstudio (local)</option></select></label>
<label>Endpoint<input id="endpoint" placeholder="http://127.0.0.1:1234/v1"/><small>Must end with <code>/v1</code> for LM Studio</small></label>
<label>API key<input id="api_key" placeholder="lm-studio"/></label>
<label>Model<input id="model" placeholder="Paste exact LM Studio model name"/></label>
<label>Max history<input id="max_history" type="number" value="12" min="4" max="32"/></label>
<h3 style="grid-column:1/-1;margin:0;">TTS</h3>
<label>Provider<select id="tts_provider"><option value="fish_audio">Fish Audio (cloud/self-host)</option><option value="piper_local">Piper (local CLI)</option><option value="xtts_server">XTTS Server (local)</option><option value="elevenlabs">ElevenLabs (API)</option></select></label>
<label>TTS Endpoint<input id="tts_endpoint" placeholder="https://api.fish.audio/v1"/><small>For self-host, paste your base URL (e.g., http://127.0.0.1:8001/v1)</small></label>
<label>TTS API key<input id="tts_api_key" placeholder="Required for cloud providers"/></label>
<label>TTS Voice/ID<input id="tts_voice_id" placeholder="Fish voice_id or ElevenLabs voice_id"/><small>Defaults to E-girl for Fish Audio</small></label>
<label>Format<select id="tts_format"><option>mp3</option><option>wav</option><option>opus</option></select></label>
<label>Sample rate<input id="tts_sr" type="number" value="24000"/></label>
<label>Piper voice path<input id="piper_voice" placeholder="Path to .onnx (Piper)"/></label>
<div class="actions"><button id="saveCfg">Save</button><span id="saveMsg"></span></div>
</div></section>
<section id="viewer" class="tab"><h2>Viewer</h2>
<div class="card"><input type="file" id="file" accept=".vrm,.glb,.gltf"/><button id="upload">Upload Model</button><div id="uploadMsg"></div></div>
<div class="card"><h3>Available Models</h3><ul id="models"></ul></div>
</section>
<section id="chat" class="tab"><h2>Chat</h2>
<div class="card"><textarea id="msg" rows="3" placeholder="Say hi…"></textarea>
<div style="display:flex;gap:8px;align-items:center;margin-top:8px;"><button id="send">Send</button>
<label style="display:flex;align-items:center;gap:6px;"><input id="speak" type="checkbox" checked/><span>Speak replies</span></label></div>
</div><div id="log"></div></section>
<section id="system" class="tab"><h2>System</h2><div class="card"><button id="refreshHealth">Refresh</button><pre id="health"></pre></div></section>
</main>
<script type="module">
const $=(q)=>document.querySelector(q);
document.querySelectorAll('.tabbtn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));document.getElementById(b.dataset.tab).classList.add('active');}));
async function loadCfg(){const r=await fetch('/api/config');const j=await r.json();
  document.getElementById('provider').value=j.llm?.provider||'lmstudio';
  document.getElementById('endpoint').value=j.llm?.endpoint||'http://127.0.0.1:1234/v1';
  document.getElementById('api_key').value=j.llm?.api_key||'lm-studio';
  document.getElementById('model').value=j.llm?.model||'';
  document.getElementById('max_history').value=j.memory?.max_history||12;
  document.getElementById('tts_provider').value=j.tts?.provider||'fish_audio';
  document.getElementById('tts_endpoint').value=j.tts?.endpoint||'https://api.fish.audio/v1';
  document.getElementById('tts_api_key').value=j.tts?.api_key||'';
  document.getElementById('tts_voice_id').value=j.tts?.voice_id||'';
  document.getElementById('tts_format').value=j.tts?.format||'mp3';
  document.getElementById('tts_sr').value=j.tts?.sample_rate||24000;
  document.getElementById('piper_voice').value=j.tts?.voice||'';
}
document.getElementById('saveCfg').onclick=async()=>{
  const body={llm:{provider:$('#provider').value,endpoint:$('#endpoint').value,api_key:$('#api_key').value,model:$('#model').value},
  memory:{max_history:parseInt($('#max_history').value||'12')},
  tts:{provider:$('#tts_provider').value,endpoint:$('#tts_endpoint').value,api_key:$('#tts_api_key').value,voice_id:$('#tts_voice_id').value,format:$('#tts_format').value,sample_rate:parseInt($('#tts_sr').value||'24000'),voice:$('#piper_voice').value}};
  const r=await fetch('/api/config',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  document.getElementById('saveMsg').textContent=(r.ok?'Saved ✅':'Failed ❌'); setTimeout(()=>document.getElementById('saveMsg').textContent='',2000);
};
loadCfg();
async function listModels(){const ul=$('#models'); ul.innerHTML=''; const r=await fetch('/api/avatars'); const j=await r.json();
  j.avatars.forEach(a=>{const li=document.createElement('li'); li.innerHTML=`<span>${a.name}</span><a class="btn" href="/frontend/viewer/viewer.html?url=${encodeURIComponent(a.url)}" target="_blank">Open</a><button data-del="${a.name}">Delete</button>`; ul.appendChild(li);
    li.querySelector('button').onclick=async()=>{await fetch('/api/avatars/'+encodeURIComponent(a.name),{method:'DELETE'}); listModels();};});}
document.getElementById('upload').onclick=async()=>{const f=document.getElementById('file').files[0]; if(!f){document.getElementById('uploadMsg').textContent='Pick a .vrm/.glb/.gltf file first.'; return;}
  const fd=new FormData(); fd.append('file', f); const r=await fetch('/api/avatars/upload',{method:'POST',body:fd}); const j=await r.json();
  document.getElementById('uploadMsg').textContent=j.ok?'Uploaded ✅':('Failed ❌ '+(j.error||'')); listModels();};
listModels();
let lastAudio=null; function playUrl(u){try{if(lastAudio){lastAudio.pause(); lastAudio=null;}}catch{} lastAudio=new Audio(u); lastAudio.play().catch(console.error);}
document.getElementById('send').onclick=async()=>{const text=document.getElementById('msg').value.trim(); if(!text) return; document.getElementById('msg').value='';
  const log=document.getElementById('log'); const me=document.createElement('div'); me.className='bubble me'; me.textContent=text; log.appendChild(me);
  const speak=document.getElementById('speak').checked;
  const r=await fetch('/api/chat?session_id=1',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,speak})}); const j=await r.json();
  const ai=document.createElement('div'); ai.className='bubble ai'; ai.textContent=j.ok? j.reply : ('Error: '+j.error); log.appendChild(ai); log.scrollTop=log.scrollHeight;
  if(j.ok && j.audio){ playUrl(j.audio); }};
document.getElementById('refreshHealth').onclick=async()=>{const r=await fetch('/api/healthcheck'); const j=await r.json(); document.getElementById('health').textContent=JSON.stringify(j,null,2);};
</script></body></html>
